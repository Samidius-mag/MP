# Minecraft Server Integration

Серверная часть для игры Minecraft работает как отдельный процесс на порту **27015**.

## Настройка

### 1. Установка зависимостей

```bash
cd server
npm install
```

### 2. Настройка переменных окружения

Добавьте следующие переменные в файл `server/env.example`:

```env
# Minecraft Server
MINECRAFT_PORT=27015
MINECRAFT_VERSION=1.20.1
MINECRAFT_MOTD=Minecraft Server
MINECRAFT_MAX_PLAYERS=20
MINECRAFT_ONLINE_MODE=true
```

## Запуск сервера

### Через PM2 (рекомендуется)

Minecraft сервер настроен в `ecosystem.config.js` и запускается отдельно:

```bash
# Запуск всех сервисов через PM2
pm2 start ecosystem.config.js

# Или только Minecraft сервер
pm2 start server/minecraft.js --name minecraft-server

# Просмотр статуса
pm2 status

# Просмотр логов
pm2 logs minecraft-server

# Остановка
pm2 stop minecraft-server

# Перезапуск
pm2 restart minecraft-server
```

### Прямой запуск (для разработки)

```bash
cd server
node minecraft.js
```

Сервер будет доступен на порту **27015**.

## Подключение к серверу

Игроки могут подключиться к серверу используя:
- **Адрес**: `localhost:27015` (для локального подключения)
- **Версия**: 1.16.4 (или версия, указанная в `MINECRAFT_VERSION`)

**⚠️ ВАЖНО:** Сервер использует библиотеку `flying-squid` версии 1.11.0, которая поддерживает версии Minecraft **до 1.16.4 включительно**. 

**Версии 1.17 и выше НЕ поддерживаются** из-за значительных изменений в протоколе Minecraft. Если вы попытаетесь подключиться с клиентом версии 1.17+, вы получите ошибки парсинга данных.

**Рекомендуемые версии для подключения:**
- 1.16.4 (рекомендуется)
- 1.15.2
- 1.14.4
- 1.13.2

## Управление через PM2

Все операции управления выполняются через PM2:

```bash
# Запуск
pm2 start minecraft-server

# Остановка
pm2 stop minecraft-server

# Перезапуск
pm2 restart minecraft-server

# Просмотр логов
pm2 logs minecraft-server

# Просмотр статистики
pm2 show minecraft-server

# Мониторинг
pm2 monit
```

## Команды в игре

Игроки могут использовать следующие команды в чате:

- `/help` - Показать список доступных команд
- `/list` - Показать список игроков онлайн
- `/time` - Показать текущее время

## Функциональность

- ✅ Подключение и отключение игроков
- ✅ Хранение информации об игроках в памяти (во время работы сервера)
- ✅ Чат между игроками
- ✅ Система команд (`/help`, `/list`, `/time`)
- ✅ Автоматический перезапуск через PM2
- ✅ Логирование в файлы PM2

## Структура файлов

- `server/minecraft.js` - Точка входа для запуска через PM2
- `server/minecraft-server.js` - Основной файл сервера с логикой
- `server/services/minecraftService.js` - Сервис для управления игроками в памяти
- `ecosystem.config.js` - Конфигурация PM2 (включает настройки для Minecraft сервера)

## Примечания

- Сервер использует библиотеку **`flying-squid`** версии 1.11.0 для создания полноценного Minecraft сервера
- Сервер создает игровой мир с блоками, сущностями и полной поддержкой игровой механики
- По умолчанию **отключен онлайн-режим** (`MINECRAFT_ONLINE_MODE=false`) - это позволяет подключаться нелицензионным версиям игры
- Для включения проверки лицензии установите `MINECRAFT_ONLINE_MODE=true`
- Мир сервера сохраняется в папке `minecraft-world` в корне проекта
- Информация об игроках хранится только в памяти во время работы сервера
- Сервер работает как отдельный процесс, независимо от основного Express сервера
- Логи сохраняются в `/var/log/pm2/minecraft-server-*.log`

## Устранение неполадок

### Сервер не запускается
- Проверьте, что порт 27015 не занят другим приложением
- Убедитесь, что все зависимости установлены (`npm install` в папке `server`)
- Проверьте логи PM2: `pm2 logs minecraft-server`

### Игроки не могут подключиться
- Проверьте настройки файрвола
- Убедитесь, что порт 27015 открыт для входящих соединений (TCP)
- Проверьте версию клиента Minecraft (должна совпадать с `MINECRAFT_VERSION` в настройках)
- Проверьте, что сервер запущен: `pm2 status`

### Мир пустой (только облака)
Если мир пустой или не генерируется правильно:
```bash
# Остановите сервер
pm2 stop minecraft-server

# Удалите старый мир
rm -rf minecraft-world

# Запустите сервер снова (создаст новый мир)
pm2 start minecraft-server
```

### Ошибка UUID при подключении
Если игрок выкидывается с ошибкой UUID - это известный баг в `flying-squid`. 
Сервер теперь игнорирует эти ошибки и не отключает игроков. 
Если проблема сохраняется, попробуйте:
- Подключиться с клиентом версии 1.16.4 (точно совместимо)
- Убедитесь, что используется офлайн-режим (`MINECRAFT_ONLINE_MODE=false`)

### Проблемы с PM2
- Убедитесь, что PM2 установлен: `npm install -g pm2`
- Проверьте конфигурацию в `ecosystem.config.js`
- Для перезапуска используйте: `pm2 restart minecraft-server`


# üí≥ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –°–ë–ü –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ –í–¢–ë API

## üéØ –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å [–í–¢–ë –°–ë–ü API](https://sandbox.vtb.ru/integration/api/rest.html#sbp-payments) –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ –°–∏—Å—Ç–µ–º—É –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π (–°–ë–ü).

## üîß –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤** –¥–ª—è –°–ë–ü –ø–ª–∞—Ç–µ–∂–µ–π
- **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–æ–≤** –¥–ª—è –æ–ø–ª–∞—Ç—ã
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞** –ø–ª–∞—Ç–µ–∂–µ–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- **Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –æ—Ç –í–¢–ë
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏** —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (HMAC-SHA256 –∏ RSA-SHA512)
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** –±–∞–ª–∞–Ω—Å–∞ –¥–µ–ø–æ–∑–∏—Ç–∞
- **–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ** —Å QR-–∫–æ–¥–æ–º –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤

## üóÑÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°–µ—Ä–≤–∏—Å—ã:
- `VtbSbpService` - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –í–¢–ë API
- `Payment routes` - –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
- `Webhook handler` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç –í–¢–ë

### API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:
- `POST /api/payment/deposit` - —Å–æ–∑–¥–∞–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞ —Å –°–ë–ü
- `POST /api/payment/sbp-webhook` - webhook –æ—Ç –í–¢–ë
- `GET /api/payment/sbp-status/:orderId` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –í–¢–ë API

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –≤ [–í–¢–ë –ë–∏–∑–Ω–µ—Å –û–Ω–ª–∞–π–Ω](https://www.vtb.ru/business/)
2. –ü–æ–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –°–ë–ü API
3. –ü–æ–ª—É—á–∏—Ç–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
   - Merchant ID
   - API Username/Password –∏–ª–∏ Token
   - –°–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ `server/env-sbp-example.txt` –≤ `.env`:

```bash
# –í–¢–ë –°–ë–ü API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
VTB_SBP_BASE_URL=https://sandbox.vtb.ru/integration/api/rest
VTB_MERCHANT_ID=your_merchant_id
VTB_USER_NAME=your_api_username
VTB_PASSWORD=your_api_password

# –î–ª—è —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ–π –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
VTB_SECRET_KEY=your_secret_key

# URL –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
SERVER_BASE_URL=http://localhost:5000
CLIENT_BASE_URL=http://localhost:3000
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook URL

–í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –í–¢–ë —É–∫–∞–∂–∏—Ç–µ URL –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
```
https://yourdomain.com/api/payment/sbp-webhook
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ –º–µ—Ç–æ–¥–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏:

#### 1. –°–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è (HMAC-SHA256)
```javascript
const dataString = 'amount;123456;mdOrder;order-id;operation;deposited;orderNumber;10747;status;1;';
const signature = crypto.createHmac('sha256', secretKey).update(dataString).digest('hex');
```

#### 2. –ê—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è (RSA-SHA512)
```javascript
const dataString = 'amount;123456;mdOrder;order-id;operation;deposited;orderNumber;10747;status;1;';
const signature = crypto.createSign('sha512').update(dataString).sign(privateKey, 'hex');
```

## üì± –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

### –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –°–ë–ü
- **QR-–∫–æ–¥** –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±–∞–Ω–∫–æ–≤—Å–∫–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- **–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞** –∏ ID –∑–∞–∫–∞–∑–∞
- **–°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞** –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- **–ö–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ"** –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥

### –°—Ç–∞—Ç—É—Å—ã –ø–ª–∞—Ç–µ–∂–µ–π:
- `pending` - –û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã
- `1` - –û–ø–ª–∞—á–µ–Ω–æ
- `2` - –û—Ç–∫–ª–æ–Ω–µ–Ω–æ
- `3` - –û—Ç–º–µ–Ω–µ–Ω–æ

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
```javascript
const paymentData = {
  orderNumber: 'pay_1640995200000_abc123',
  amount: 1000000, // 10,000 ‚ÇΩ –≤ –∫–æ–ø–µ–π–∫–∞—Ö
  description: '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞ –Ω–∞ 10000 ‚ÇΩ',
  returnUrl: 'https://client.com/deposit?success=true',
  failUrl: 'https://client.com/deposit?error=true',
  notificationUrl: 'https://server.com/api/payment/sbp-webhook'
};
```

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ QR-–∫–æ–¥–∞
```javascript
const result = await vtbSbpService.createSbpPayment(paymentData);
// result.qrCode - base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ QR-–∫–æ–¥–∞
// result.qrCodeUrl - URL –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è QR-–∫–æ–¥–∞
// result.paymentUrl - —Å—Å—ã–ª–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```javascript
const status = await vtbSbpService.checkPaymentStatus(orderId);
// status.status - —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
// status.amount - —Å—É–º–º–∞
// status.operation - —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–≥–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å:
```javascript
console.log('SBP Webhook received:', webhookData);
console.log('SBP payment completed for deposit', depositId);
console.log('SBP payment failed for deposit', depositId);
```

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º
- –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞: "–î–µ–ø–æ–∑–∏—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ X ‚ÇΩ —á–µ—Ä–µ–∑ –°–ë–ü"
- –û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã: "–ü–ª–∞—Ç–µ–∂ –æ—Ç–∫–ª–æ–Ω–µ–Ω –∏–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω"

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Sandbox –æ–∫—Ä—É–∂–µ–Ω–∏–µ
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –í–¢–ë:
```
VTB_SBP_BASE_URL=https://sandbox.vtb.ru/integration/api/rest
```

### –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
- –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
- –¢–µ—Å—Ç–æ–≤—ã–µ —Å—É–º–º—ã (–¥–æ 1000 ‚ÇΩ)
- –¢–µ—Å—Ç–æ–≤—ã–µ webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
cd server
npm install
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
cp env-sbp-example.txt .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
```

### 3. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
```bash
npm start
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
```bash
curl -X POST http://localhost:5000/api/payment/deposit \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"amount": 1000, "payment_method": "sbp"}'
```

## üîß API Reference

### VtbSbpService

#### createSbpPayment(paymentData)
–°–æ–∑–¥–∞–µ—Ç –°–ë–ü –ø–ª–∞—Ç–µ–∂ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç QR-–∫–æ–¥.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `orderNumber` - –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
- `amount` - —Å—É–º–º–∞ –≤ –∫–æ–ø–µ–π–∫–∞—Ö
- `description` - –æ–ø–∏—Å–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
- `returnUrl` - URL –≤–æ–∑–≤—Ä–∞—Ç–∞
- `failUrl` - URL –ø—Ä–∏ –æ—à–∏–±–∫–µ
- `notificationUrl` - URL –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```javascript
{
  success: true,
  orderId: "order-id",
  qrCode: "base64-qr-code",
  qrCodeUrl: "https://qr-url",
  paymentUrl: "https://payment-url",
  amount: 1000000
}
```

#### checkPaymentStatus(orderId)
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```javascript
{
  success: true,
  orderId: "order-id",
  status: "1",
  amount: 1000000,
  operation: "deposited"
}
```

#### verifyNotificationSignature(data, signature)
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `boolean`

## üêõ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

#### 1. –û—à–∏–±–∫–∞ "Invalid signature"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `VTB_SECRET_KEY`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º (HMAC-SHA256)

#### 2. –û—à–∏–±–∫–∞ "Order not found"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `orderId` –≤ webhook
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–∫–∞–∑ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

#### 3. QR-–∫–æ–¥ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `VTB_SBP_BASE_URL`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

#### 4. Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `notificationUrl`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –í–¢–ë

### –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:
```javascript
// –í–∫–ª—é—á–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
console.log('SBP Webhook received:', JSON.stringify(webhookData, null, 2));
console.log('Signature verification:', vtbSbpService.verifyNotificationSignature(webhookData, signature));
```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
2. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
3. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –í–¢–ë
4. –°–æ–∑–¥–∞–π—Ç–µ —Ç–∏–∫–µ—Ç –≤ —Å–∏—Å—Ç–µ–º–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [–í–¢–ë –°–ë–ü API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://sandbox.vtb.ru/integration/api/rest.html#sbp-payments)
- [–í–¢–ë –ë–∏–∑–Ω–µ—Å –û–Ω–ª–∞–π–Ω](https://www.vtb.ru/business/)
- [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –í–¢–ë](https://www.vtb.ru/business/support/)



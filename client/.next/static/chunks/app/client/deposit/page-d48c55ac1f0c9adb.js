(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[572],{907:function(e,s,a){Promise.resolve().then(a.bind(a,9637))},9637:function(e,s,a){"use strict";a.r(s),a.d(s,{default:function(){return m}});var t=a(7437),r=a(2265),l=a(4133),n=a(826),c=a(5925),d=a(4209),i=a(7993),o=a(1733),x=a(5255);function m(){let[e,s]=(0,r.useState)(0),[a,m]=(0,r.useState)([]),[h,u]=(0,r.useState)(!0),[j,p]=(0,r.useState)(!1),[f,g]=(0,r.useState)(""),[N,y]=(0,r.useState)("sbp"),[b,v]=(0,r.useState)(!1),[w,k]=(0,r.useState)(!1),[C,_]=(0,r.useState)(null),[S,L]=(0,r.useState)("pending");(0,r.useEffect)(()=>{U()},[]);let U=async()=>{try{let[e,a]=await Promise.all([n.h.get("/client/balance"),n.h.get("/client/deposits?limit=20")]);s(e.data.balance),m(a.data.deposits)}catch(e){console.error("Error fetching deposit data:",e),c.default.error("Ошибка загрузки данных")}finally{u(!1)}},R=async e=>{if(e.preventDefault(),!f||0>=parseFloat(f)){c.default.error("Введите корректную сумму");return}v(!0);try{let{paymentUrl:e,invoiceFile:s}=(await n.h.post("/payment/deposit",{amount:parseFloat(f),payment_method:N})).data;e&&("bank_transfer"===e.type?(c.default.success("Реквизиты для перевода отправлены на email"),console.log("Bank transfer details:",e.details)):"sbp"===e.type?e.qrCode?(k(!0),_({qrCode:e.qrCode,qrCodeUrl:e.qrCodeUrl,paymentUrl:e.paymentUrl,orderId:e.orderId,amount:e.amount})):e.paymentUrl?window.open(e.paymentUrl,"_blank"):e.error&&c.default.error(e.error):window.open(e.url,"_blank")),s&&c.default.success("PDF счет сгенерирован. Вы можете скачать его ниже."),p(!1),g(""),c.default.success("Платеж создан успешно")}catch(e){var s,a;c.default.error((null===(a=e.response)||void 0===a?void 0:null===(s=a.data)||void 0===s?void 0:s.error)||"Ошибка создания платежа")}finally{v(!1)}},q=e=>{switch(e){case"deposit":return(0,t.jsx)(d.Z,{className:"h-5 w-5 text-green-600"});case"withdrawal":return(0,t.jsx)(i.Z,{className:"h-5 w-5 text-red-600"});case"order_payment":return(0,t.jsx)(o.Z,{className:"h-5 w-5 text-blue-600"});default:return(0,t.jsx)(o.Z,{className:"h-5 w-5 text-gray-600"})}},I=e=>{switch(e){case"deposit":return"Пополнение";case"withdrawal":return"Списание";case"order_payment":return"Оплата заказа";default:return e}},Z=async e=>{try{let{status:s,localStatus:a}=(await n.h.get("/payment/sbp-status/".concat(e))).data;L(s),"1"===s&&"completed"===a?(c.default.success("Платеж успешно завершен!"),k(!1),U()):("2"===s||"3"===s)&&(c.default.error("Платеж отклонен или отменен"),k(!1))}catch(e){console.error("Error checking SBP status:",e)}};(0,r.useEffect)(()=>{if(w&&(null==C?void 0:C.orderId)){let e=setInterval(()=>{Z(C.orderId)},5e3);return()=>clearInterval(e)}},[w,C]);let E=e=>{switch(e){case"completed":return(0,t.jsx)("span",{className:"badge-success",children:"Завершено"});case"pending":return(0,t.jsx)("span",{className:"badge-warning",children:"Ожидает"});case"failed":return(0,t.jsx)("span",{className:"badge-danger",children:"Ошибка"});default:return(0,t.jsx)("span",{className:"badge-gray",children:e})}};return h?(0,t.jsx)(l.Z,{requiredRole:"client",children:(0,t.jsx)("div",{className:"flex items-center justify-center h-64",children:(0,t.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"})})}):(0,t.jsxs)(l.Z,{requiredRole:"client",children:[(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)("div",{className:"flex justify-between items-center",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"Депозит"}),(0,t.jsx)("p",{className:"mt-1 text-sm text-gray-600",children:"Управление балансом и история операций"})]}),(0,t.jsxs)("button",{onClick:()=>p(!0),className:"btn-primary",children:[(0,t.jsx)(x.Z,{className:"h-5 w-5 mr-2"}),"Пополнить"]})]}),(0,t.jsx)("div",{className:"card",children:(0,t.jsx)("div",{className:"card-body",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"text-lg font-medium text-gray-900",children:"Текущий баланс"}),(0,t.jsxs)("p",{className:"text-3xl font-bold text-primary-600",children:[e.toLocaleString("ru-RU")," ₽"]})]}),(0,t.jsxs)("div",{className:"text-right",children:[(0,t.jsx)("p",{className:"text-sm text-gray-500",children:"Доступно для заказов"}),(0,t.jsxs)("p",{className:"text-lg font-semibold text-gray-900",children:[e.toLocaleString("ru-RU")," ₽"]})]})]})})}),j&&(0,t.jsxs)("div",{className:"card",children:[(0,t.jsx)("div",{className:"card-header",children:(0,t.jsx)("h3",{className:"text-lg font-medium text-gray-900",children:"Пополнить депозит"})}),(0,t.jsx)("div",{className:"card-body",children:(0,t.jsxs)("form",{onSubmit:R,className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"label",children:"Сумма пополнения"}),(0,t.jsx)("input",{type:"number",value:f,onChange:e=>g(e.target.value),className:"input",placeholder:"Введите сумму",min:"1",step:"0.01",required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"label",children:"Способ оплаты"}),(0,t.jsxs)("select",{value:N,onChange:e=>y(e.target.value),className:"input",children:[(0,t.jsx)("option",{value:"sbp",children:"СБП"}),(0,t.jsx)("option",{value:"yukassa",children:"ЮKassa"}),(0,t.jsx)("option",{value:"tinkoff",children:"Тинькофф"}),(0,t.jsx)("option",{value:"bank_transfer",children:"Банковский перевод"})]})]}),(0,t.jsxs)("div",{className:"flex justify-end space-x-3",children:[(0,t.jsx)("button",{type:"button",onClick:()=>p(!1),className:"btn-secondary",children:"Отмена"}),(0,t.jsx)("button",{type:"submit",disabled:b,className:"btn-primary",children:b?"Создание...":"Создать платеж"})]})]})})]}),(0,t.jsxs)("div",{className:"card",children:[(0,t.jsx)("div",{className:"card-header",children:(0,t.jsx)("h3",{className:"text-lg font-medium text-gray-900",children:"История операций"})}),(0,t.jsx)("div",{className:"card-body",children:a.length>0?(0,t.jsx)("div",{className:"space-y-4",children:a.map(e=>(0,t.jsxs)("div",{className:"flex items-center justify-between p-4 bg-gray-50 rounded-lg",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-3",children:[q(e.transaction_type),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-sm font-medium text-gray-900",children:I(e.transaction_type)}),(0,t.jsx)("p",{className:"text-sm text-gray-500",children:e.description}),(0,t.jsx)("p",{className:"text-xs text-gray-400",children:new Date(e.created_at).toLocaleString("ru-RU")})]})]}),(0,t.jsxs)("div",{className:"text-right",children:[(0,t.jsxs)("p",{className:"text-sm font-medium ".concat(e.amount>0?"text-green-600":"text-red-600"),children:[e.amount>0?"+":"",e.amount.toLocaleString("ru-RU")," ₽"]}),(0,t.jsxs)("p",{className:"text-xs text-gray-500",children:["Баланс: ",e.balance_after.toLocaleString("ru-RU")," ₽"]}),(0,t.jsx)("div",{className:"mt-1",children:E(e.status)})]})]},e.id))}):(0,t.jsxs)("div",{className:"text-center py-6",children:[(0,t.jsx)(o.Z,{className:"mx-auto h-12 w-12 text-gray-400"}),(0,t.jsx)("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"Нет операций"}),(0,t.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"История операций с депозитом появится здесь."})]})})]})]}),w&&C&&(0,t.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,t.jsxs)("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4",children:[(0,t.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,t.jsx)("h3",{className:"text-lg font-medium text-gray-900",children:"Оплата через СБП"}),(0,t.jsx)("button",{onClick:()=>k(!1),className:"text-gray-400 hover:text-gray-600",children:(0,t.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("p",{className:"text-gray-600 mb-4",children:"Отсканируйте QR-код в приложении вашего банка для оплаты"}),(0,t.jsxs)("div",{className:"mb-4",children:[(0,t.jsxs)("p",{className:"text-2xl font-bold text-gray-900 mb-2",children:[C.amount," ₽"]}),(0,t.jsxs)("p",{className:"text-sm text-gray-500",children:["ID заказа: ",C.orderId]})]}),C.qrCode&&(0,t.jsx)("div",{className:"mb-4",children:(0,t.jsx)("img",{src:C.qrCodeUrl||"data:image/png;base64,".concat(C.qrCode),alt:"QR код для оплаты",className:"mx-auto border border-gray-200 rounded",style:{width:"200px",height:"200px"}})}),(0,t.jsxs)("div",{className:"mb-4",children:[(0,t.jsx)("p",{className:"text-sm text-gray-500 mb-2",children:"Статус:"}),(0,t.jsxs)("div",{className:"flex items-center justify-center",children:["pending"===S&&(0,t.jsxs)("div",{className:"flex items-center text-yellow-600",children:[(0,t.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-yellow-600 mr-2"}),"Ожидание оплаты..."]}),"1"===S&&(0,t.jsxs)("div",{className:"flex items-center text-green-600",children:[(0,t.jsx)("svg",{className:"w-4 h-4 mr-2",fill:"currentColor",viewBox:"0 0 20 20",children:(0,t.jsx)("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),"Оплачено"]}),("2"===S||"3"===S)&&(0,t.jsxs)("div",{className:"flex items-center text-red-600",children:[(0,t.jsx)("svg",{className:"w-4 h-4 mr-2",fill:"currentColor",viewBox:"0 0 20 20",children:(0,t.jsx)("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})}),"Отклонено"]})]})]}),C.paymentUrl&&(0,t.jsx)("div",{className:"mb-4",children:(0,t.jsxs)("a",{href:C.paymentUrl,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:[(0,t.jsx)("svg",{className:"w-4 h-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"})}),"Открыть в браузере"]})}),(0,t.jsxs)("div",{className:"flex space-x-3",children:[(0,t.jsx)("button",{onClick:()=>Z(C.orderId),className:"flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200",children:"Проверить статус"}),(0,t.jsx)("button",{onClick:()=>k(!1),className:"flex-1 px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700",children:"Закрыть"})]})]})]})})]})}}},function(e){e.O(0,[737,251,703,133,971,938,744],function(){return e(e.s=907)}),_N_E=e.O()}]);
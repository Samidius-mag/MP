"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[48],{8048:function(e,t,a){a.d(t,{Z:function(){return m}});var r=a(7437),s=a(2265),o=a(1865),l=a(9438),n=a(4033),i=a(5925),c=a(1396),d=a.n(c);function u(e){let{userId:t,onComplete:a}=e,[o,n]=(0,s.useState)(""),[c,d]=(0,s.useState)(!1),{verifyTwoFactor:u}=(0,l.useAuth)(),h=async e=>{if(e.preventDefault(),6!==o.length){i.default.error("Введите 6-значный код");return}d(!0);try{let e=await u(t,o);a(e),i.default.success("2FA подтвержден успешно")}catch(e){i.default.error(e.message||"Ошибка подтверждения 2FA")}finally{d(!1)}};return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("h2",{className:"text-2xl font-bold text-gray-900",children:"Двухфакторная аутентификация"}),(0,r.jsx)("p",{className:"mt-2 text-gray-600",children:"Введите код из приложения аутентификатора"})]}),(0,r.jsxs)("form",{onSubmit:h,className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"code",className:"label",children:"Код аутентификации"}),(0,r.jsx)("input",{type:"text",value:o,onChange:e=>n(e.target.value.replace(/\D/g,"").slice(0,6)),placeholder:"000000",className:"input text-center text-lg tracking-widest",maxLength:6,autoComplete:"off"})]}),(0,r.jsx)("button",{type:"submit",disabled:c||6!==o.length,className:"btn-primary w-full",children:c?"Проверка...":"Подтвердить"})]})]})}function h(e){let{userId:t,onComplete:a}=e,[o,n]=(0,s.useState)(""),[c,d]=(0,s.useState)(""),[u,h]=(0,s.useState)(""),[m,p]=(0,s.useState)(!1),{forceChangePassword:v}=(0,l.useAuth)(),f=async e=>{if(e.preventDefault(),c!==u){i.default.error("Пароли не совпадают");return}if(c.length<8){i.default.error("Пароль должен содержать минимум 8 символов");return}p(!0);try{await v(t,o,c),i.default.success("Пароль успешно изменен"),a()}catch(e){i.default.error(e.message||"Ошибка смены пароля")}finally{p(!1)}};return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("h2",{className:"text-2xl font-bold text-gray-900",children:"Смена пароля"}),(0,r.jsx)("p",{className:"mt-2 text-gray-600",children:"Необходимо сменить пароль при первом входе"})]}),(0,r.jsxs)("form",{onSubmit:f,className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"currentPassword",className:"label",children:"Текущий пароль"}),(0,r.jsx)("input",{type:"password",value:o,onChange:e=>n(e.target.value),className:"input",placeholder:"Введите текущий пароль",required:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"newPassword",className:"label",children:"Новый пароль"}),(0,r.jsx)("input",{type:"password",value:c,onChange:e=>d(e.target.value),className:"input",placeholder:"Введите новый пароль",required:!0,minLength:8}),(0,r.jsx)("p",{className:"mt-1 text-xs text-gray-500",children:"Минимум 8 символов, 1 заглавная буква, 1 спецсимвол"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"confirmPassword",className:"label",children:"Подтверждение пароля"}),(0,r.jsx)("input",{type:"password",value:u,onChange:e=>h(e.target.value),className:"input",placeholder:"Подтвердите новый пароль",required:!0,minLength:8})]}),(0,r.jsx)("button",{type:"submit",disabled:m||!o||!c||!u,className:"btn-primary w-full",children:m?"Смена пароля...":"Сменить пароль"})]})]})}function m(){let[e,t]=(0,s.useState)(!1),[a,c]=(0,s.useState)("login"),[m,p]=(0,s.useState)(null),[v,f]=(0,s.useState)(null),{login:x,verifyTwoFactor:g,forceChangePassword:w}=(0,l.useAuth)();(0,n.useRouter)();let{register:y,handleSubmit:j,formState:{errors:b}}=(0,o.cI)(),N=async e=>{t(!0);try{let t=await x(e.email,e.password);t.requiresTwoFactor?(p({userId:t.userId}),c("2fa")):t.requiresPasswordChange?(f({userId:t.userId}),c("password-change")):i.default.success("Вход выполнен успешно")}catch(e){i.default.error(e.message||"Ошибка входа")}finally{t(!1)}},A=async e=>{i.default.success("Вход выполнен успешно"),window.location.href="/client/dashboard"};return"2fa"===a&&m?(0,r.jsx)(u,{userId:m.userId,onComplete:A}):"password-change"===a&&v?(0,r.jsx)(h,{userId:v.userId,onComplete:()=>{i.default.success("Пароль успешно изменен. Войдите в систему с новым паролем."),c("login"),f(null)}}):(0,r.jsxs)("div",{children:[(0,r.jsxs)("form",{className:"space-y-6",onSubmit:j(N),children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"email",className:"label",children:"Email или телефон"}),(0,r.jsx)("input",{...y("email",{required:"Email или телефон обязателен",pattern:{value:/^([A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}|[\+]?[1-9][\d]{0,15})$/i,message:"Неверный формат email или телефона"}}),type:"text",className:"input ".concat(b.email?"input-error":""),placeholder:"Введите email или телефон",autoComplete:"off"}),b.email&&(0,r.jsx)("p",{className:"mt-1 text-sm text-red-600",children:b.email.message})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"password",className:"label",children:"Пароль"}),(0,r.jsx)("input",{...y("password",{required:"Пароль обязателен"}),type:"password",className:"input ".concat(b.password?"input-error":""),placeholder:"Введите ваш пароль",autoComplete:"current-password"}),b.password&&(0,r.jsx)("p",{className:"mt-1 text-sm text-red-600",children:b.password.message})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("input",{...y("rememberMe"),type:"checkbox",className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"}),(0,r.jsx)("label",{htmlFor:"rememberMe",className:"ml-2 text-sm text-gray-700",children:"Запомнить меня"})]}),(0,r.jsx)("div",{className:"text-sm",children:(0,r.jsx)("a",{href:"/forgot-password",className:"text-blue-600 hover:text-blue-500",children:"Забыли пароль?"})})]}),(0,r.jsx)("div",{children:(0,r.jsx)("button",{type:"submit",disabled:e,className:"btn-primary w-full",children:e?"Вход...":"Войти"})})]}),(0,r.jsxs)("div",{className:"mt-6",children:[(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("div",{className:"absolute inset-0 flex items-center",children:(0,r.jsx)("div",{className:"w-full border-t border-gray-300"})}),(0,r.jsx)("div",{className:"relative flex justify-center text-sm",children:(0,r.jsx)("span",{className:"px-2 bg-white text-gray-500",children:"Или"})})]}),(0,r.jsx)("div",{className:"mt-6",children:(0,r.jsx)(d(),{href:"/register",className:"w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50",children:"Создать аккаунт"})})]})]})}},826:function(e,t,a){a.d(t,{h:function(){return r}});let r=a(4829).Z.create({baseURL:"/api",headers:{"Content-Type":"application/json"}});r.interceptors.response.use(e=>e,e=>{var t,a;return((null===(t=e.response)||void 0===t?void 0:t.status)===401||(null===(a=e.response)||void 0===a?void 0:a.status)===403)&&(localStorage.removeItem("token"),delete r.defaults.headers.common.Authorization,window.location.href="/login"),Promise.reject(e)}),r.interceptors.request.use(e=>{let t=localStorage.getItem("token");return t&&(e.headers.Authorization="Bearer ".concat(t)),e},e=>Promise.reject(e))},9438:function(e,t,a){a.r(t),a.d(t,{AuthProvider:function(){return c},useAuth:function(){return d}});var r=a(7437),s=a(2265),o=a(826);class l{async sendLog(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(this.isEnabled)try{await o.h.post("/admin/logs/client",{level:e,message:t,component:a.component,action:a.action,url:a.url||window.location.href,metadata:a.metadata})}catch(e){console.warn("Failed to send client log:",e)}}error(e,t){console.error("[CLIENT ERROR] ".concat(e),t),this.sendLog("error",e,t)}warn(e,t){console.warn("[CLIENT WARN] ".concat(e),t),this.sendLog("warn",e,t)}info(e,t){console.info("[CLIENT INFO] ".concat(e),t),this.sendLog("info",e,t)}debug(e,t){console.debug("[CLIENT DEBUG] ".concat(e),t),this.sendLog("debug",e,t)}userAction(e,t,a){this.info("User action: ".concat(e),{component:t,action:e,metadata:a})}apiError(e,t,a){var r;this.error("API Error: ".concat(e),{component:"API",action:"request",metadata:{endpoint:e,error:(null==t?void 0:t.message)||t,status:null==t?void 0:null===(r=t.response)||void 0===r?void 0:r.status,...a}})}navigation(e,t){this.info("Navigation: ".concat(e," -> ").concat(t),{component:"Router",action:"navigation",metadata:{from:e,to:t}})}componentError(e,t,a){this.error("Component Error: ".concat(e),{component:e,action:"render",metadata:{error:(null==t?void 0:t.message)||t,stack:null==t?void 0:t.stack,...a}})}constructor(){this.isEnabled=!0,this.isEnabled=!1}}let n=new l,i=(0,s.createContext)(void 0);function c(e){let{children:t}=e,[a,l]=(0,s.useState)(null),[c,d]=(0,s.useState)(!0);(0,s.useEffect)(()=>{u()},[]);let u=async()=>{try{let e=localStorage.getItem("token");if(!e){d(!1);return}o.h.defaults.headers.common.Authorization="Bearer ".concat(e);let t=await o.h.get("/auth/profile");l(t.data)}catch(e){console.error("Auth check failed:",e),localStorage.removeItem("token"),delete o.h.defaults.headers.common.Authorization}finally{d(!1)}},h=async(e,t)=>{try{n.info("Login attempt",{component:"Auth",action:"login",metadata:{email:e}});let{user:a,token:r,requiresTwoFactor:s,userId:i,requiresPasswordChange:c}=(await o.h.post("/auth/login",{email:e,password:t})).data;if(s)return{requiresTwoFactor:!0,userId:i};if(c)return{requiresPasswordChange:!0,userId:i};return localStorage.setItem("token",r),o.h.defaults.headers.common.Authorization="Bearer ".concat(r),l(a),n.info("Login successful",{component:"Auth",action:"login",metadata:{userId:a.id,email:e}}),{}}catch(l){var a,r,s;let t=null==l?void 0:null===(a=l.response)||void 0===a?void 0:a.status,o=null==l?void 0:null===(s=l.response)||void 0===s?void 0:null===(r=s.data)||void 0===r?void 0:r.error;throw n.apiError("/auth/login",l,{email:e}),Error(401===t?"Неверный email или пароль":500===t?"Ошибка сервера при входе":o||"Ошибка входа")}},m=async e=>{try{let{userId:t,email:a}=(await o.h.post("/auth/register",e)).data;return{userId:t,email:a}}catch(o){var t,a,r;let e=null==o?void 0:null===(t=o.response)||void 0===t?void 0:t.status,s=null==o?void 0:null===(r=o.response)||void 0===r?void 0:null===(a=r.data)||void 0===a?void 0:a.error;throw Error(409===e?"Пользователь с таким email уже существует":s||"Ошибка регистрации")}},p=async e=>{try{let t=await o.h.put("/auth/profile",e);l(e=>e?{...e,...t.data}:null)}catch(e){var t,a;throw Error((null===(a=e.response)||void 0===a?void 0:null===(t=a.data)||void 0===t?void 0:t.error)||"Ошибка обновления профиля")}},v=async(e,t)=>{try{let{token:a,user:r}=(await o.h.post("/auth/verify-2fa",{userId:e,code:t})).data;return localStorage.setItem("token",a),o.h.defaults.headers.common.Authorization="Bearer ".concat(a),l(r),a}catch(e){var a,r;throw Error((null==e?void 0:null===(r=e.response)||void 0===r?void 0:null===(a=r.data)||void 0===a?void 0:a.error)||"Ошибка подтверждения 2FA")}},f=async(e,t)=>{try{let{token:a,user:r}=(await o.h.post("/auth/verify-email",{userId:e,code:t})).data;return a&&(localStorage.setItem("token",a),o.h.defaults.headers.common.Authorization="Bearer ".concat(a),l(r)),a}catch(e){var a,r;throw Error((null==e?void 0:null===(r=e.response)||void 0===r?void 0:null===(a=r.data)||void 0===a?void 0:a.error)||"Ошибка подтверждения email")}},x=async(e,t)=>{try{await o.h.post("/auth/resend-code",{userId:e,type:t})}catch(e){var a,r;throw Error((null==e?void 0:null===(r=e.response)||void 0===r?void 0:null===(a=r.data)||void 0===a?void 0:a.error)||"Ошибка отправки кода")}},g=async e=>{try{return(await o.h.post("/auth/check-company",{inn:e})).data}catch(e){var t,a;throw Error((null==e?void 0:null===(a=e.response)||void 0===a?void 0:null===(t=a.data)||void 0===t?void 0:t.error)||"Ошибка проверки компании")}},w=async(e,t,a)=>{try{await o.h.put("/auth/force-change-password",{userId:e,currentPassword:t,newPassword:a})}catch(e){var r,s;throw Error((null==e?void 0:null===(s=e.response)||void 0===s?void 0:null===(r=s.data)||void 0===r?void 0:r.error)||"Ошибка смены пароля")}};return(0,r.jsx)(i.Provider,{value:{user:a,loading:c,login:h,register:m,logout:()=>{n.info("User logout",{component:"Auth",action:"logout",metadata:{userId:null==a?void 0:a.id}}),localStorage.removeItem("token"),delete o.h.defaults.headers.common.Authorization,l(null),window.location.href="/login"},updateProfile:p,verifyTwoFactor:v,verifyEmail:f,resendCode:x,checkCompany:g,forceChangePassword:w},children:t})}function d(){let e=(0,s.useContext)(i);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}}}]);
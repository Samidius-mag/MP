"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[133],{4133:function(e,t,r){r.d(t,{Z:function(){return A}});var a=r(7437),o=r(9438),n=r(4033),i=r(2265),s=r(1396),l=r.n(s),c=r(4992),d=r(8801),u=r(6180),h=r(3160),m=r(8265),v=r(1733),f=r(2469),p=r(9010),x=r(7965),g=r(9649),y=r(654),w=r(5518);function N(e){let{role:t}=e,{user:r,logout:i}=(0,o.useAuth)(),s=(0,n.usePathname)(),N=(null==r?void 0:r.email)==="test+deposit@example.com",b=(()=>{switch(t){case"client":return[{name:"Дашборд",href:"/client/dashboard",icon:c.Z},{name:"Заказы",href:"/client/orders",icon:d.Z},{name:"Товары магазина",href:"/client/products",icon:u.Z},{name:"Склад",href:"/client/warehouse",icon:h.Z},...N?[]:[{name:"СИМА ЛЕНД",href:"/client/sima-land",icon:m.Z}],{name:"Депозит",href:"/client/deposit",icon:v.Z},{name:"WB Ценообразование",href:"/client/wb-pricing",icon:f.Z},{name:"Настройки",href:"/client/settings",icon:p.Z}];case"operator":return[{name:"Дашборд",href:"/operator/dashboard",icon:c.Z},{name:"Заказы",href:"/operator/orders",icon:d.Z},{name:"Стикеры",href:"/operator/stickers",icon:x.Z},{name:"Клиенты",href:"/operator/clients",icon:g.Z}];case"admin":return[{name:"Дашборд",href:"/admin",icon:c.Z},{name:"Пользователи",href:"/admin/users",icon:g.Z},{name:"Заказы",href:"/admin/orders",icon:d.Z},{name:"Статистика",href:"/admin/stats",icon:y.Z},{name:"Настройки",href:"/admin/settings",icon:p.Z}];default:return[]}})();return(0,a.jsxs)("div",{className:"flex flex-col w-64 bg-white shadow-lg",children:[(0,a.jsx)("div",{className:"flex items-center justify-center h-16 px-4 bg-primary-600",children:(0,a.jsxs)("h1",{className:"text-xl font-bold text-white",children:["client"===t&&"Клиент","operator"===t&&"Оператор","admin"===t&&"Админ"]})}),(0,a.jsx)("nav",{className:"flex-1 px-4 py-6 space-y-2",children:b.map(e=>{let t=s===e.href;return(0,a.jsxs)(l(),{href:e.href,className:"flex items-center px-4 py-2 text-sm font-medium rounded-md transition-colors duration-200 ".concat(t?"bg-primary-100 text-primary-700":"text-gray-600 hover:bg-gray-100 hover:text-gray-900"),children:[(0,a.jsx)(e.icon,{className:"w-5 h-5 mr-3"}),e.name]},e.name)})}),(0,a.jsx)("div",{className:"p-4 border-t border-gray-200",children:(0,a.jsxs)("button",{onClick:i,className:"flex items-center w-full px-4 py-2 text-sm font-medium text-gray-600 rounded-md hover:bg-gray-100 hover:text-gray-900 transition-colors duration-200",children:[(0,a.jsx)(w.Z,{className:"w-5 h-5 mr-3"}),"Выйти"]})})]})}var b=r(1809),j=r(826);function E(){let{user:e}=(0,o.useAuth)(),[t,r]=(0,i.useState)(!1),[n,s]=(0,i.useState)(0),[l,c]=(0,i.useState)([]),[d,u]=(0,i.useState)(!1),h=(0,i.useRef)(0),m=(0,i.useRef)(null);(0,i.useEffect)(()=>{m.current=new Audio("/alarm.mp3"),m.current.preload="auto"},[]);let v=async()=>{try{var e,t,r,a;let[o,n]=await Promise.all([j.h.get("/notification/unread-count"),j.h.get("/notification?unread_only=true&limit=10")]),i=null!==(r=null===(e=o.data)||void 0===e?void 0:e.count)&&void 0!==r?r:0;if(s(i),c((null===(t=n.data)||void 0===t?void 0:t.notifications)||[]),i>h.current&&0!==h.current)try{await (null===(a=m.current)||void 0===a?void 0:a.play())}catch(e){}h.current=i}catch(e){}};return(0,i.useEffect)(()=>{if(d)return;u(!0),v().finally(()=>u(!1));let e=setInterval(v,15e3);return()=>clearInterval(e)},[]),(0,a.jsx)("header",{className:"bg-white shadow-sm border-b border-gray-200",children:(0,a.jsxs)("div",{className:"flex items-center justify-between px-6 py-4",children:[(0,a.jsx)("div",{className:"flex items-center",children:(0,a.jsxs)("h2",{className:"text-xl font-semibold text-gray-900",children:["Добро пожаловать, ",null==e?void 0:e.firstName," ",null==e?void 0:e.lastName]})}),(0,a.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsxs)("button",{onClick:()=>r(!t),className:"p-2 text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded-md",children:[(0,a.jsx)(x.Z,{className:"w-6 h-6"}),n>0&&(0,a.jsx)("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 px-1 min-w-[1.25rem] flex items-center justify-center",children:n})]}),t&&(0,a.jsx)("div",{className:"absolute right-0 mt-2 w-80 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 z-50",children:(0,a.jsxs)("div",{className:"py-1",children:[(0,a.jsx)("div",{className:"px-4 py-2 text-sm text-gray-700 border-b border-gray-200",children:"Уведомления"}),l.length>0?l.map(e=>(0,a.jsxs)("div",{className:"px-4 py-2 text-sm text-gray-600 border-b last:border-b-0",children:[(0,a.jsx)("div",{className:"font-medium text-gray-800",children:e.title}),(0,a.jsx)("div",{className:"text-gray-600",children:e.message}),(0,a.jsx)("div",{className:"text-xs text-gray-400 mt-1",children:new Date(e.created_at||e.sent_at).toLocaleString("ru-RU")})]},e.id)):(0,a.jsx)("div",{className:"px-4 py-3 text-sm text-gray-500",children:"Нет новых уведомлений"}),(0,a.jsx)("div",{className:"px-4 py-2",children:(0,a.jsx)("button",{onClick:async()=>{try{await j.h.put("/notification/mark-all-read"),h.current=0,v()}catch(e){}},className:"w-full text-sm text-primary-600 hover:text-primary-700",children:"Отметить все как прочитанные"})})]})})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsx)("div",{className:"w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center",children:(0,a.jsx)(b.Z,{className:"w-5 h-5 text-primary-600"})}),(0,a.jsxs)("div",{className:"text-sm",children:[(0,a.jsxs)("div",{className:"font-medium text-gray-900",children:[null==e?void 0:e.firstName," ",null==e?void 0:e.lastName]}),(0,a.jsxs)("div",{className:"text-gray-500 capitalize",children:[(null==e?void 0:e.role)==="client"&&"Клиент",(null==e?void 0:e.role)==="operator"&&"Оператор",(null==e?void 0:e.role)==="admin"&&"Администратор"]})]})]})]})]})})}function A(e){let{children:t,requiredRole:r}=e,{user:s,loading:l}=(0,o.useAuth)(),c=(0,n.useRouter)();return((0,i.useEffect)(()=>{if(!l){if(!s){c.push("/login");return}if(r&&s.role!==r){switch(s.role){case"client":c.push("/client/dashboard");break;case"operator":c.push("/operator/dashboard");break;case"admin":c.push("/admin")}return}}},[s,l,c,r]),l)?(0,a.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-primary-600"})}):!s||r&&s.role!==r?null:(0,a.jsxs)("div",{className:"min-h-screen bg-gray-50 flex",children:[(0,a.jsx)(N,{role:s.role}),(0,a.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,a.jsx)(E,{}),(0,a.jsx)("main",{className:"flex-1 p-6",children:t})]})]})}},826:function(e,t,r){r.d(t,{h:function(){return a}});let a=r(4829).Z.create({baseURL:"/api",headers:{"Content-Type":"application/json"},timeout:6e4});a.interceptors.response.use(e=>e,e=>{var t,r;return((null===(t=e.response)||void 0===t?void 0:t.status)===401||(null===(r=e.response)||void 0===r?void 0:r.status)===403)&&(localStorage.removeItem("token"),delete a.defaults.headers.common.Authorization,window.location.href="/login"),Promise.reject(e)}),a.interceptors.request.use(e=>{let t=localStorage.getItem("token");return t&&(e.headers.Authorization="Bearer ".concat(t)),e},e=>Promise.reject(e))},9438:function(e,t,r){r.r(t),r.d(t,{AuthProvider:function(){return c},useAuth:function(){return d}});var a=r(7437),o=r(2265),n=r(826);class i{async sendLog(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(this.isEnabled)try{await n.h.post("/admin/logs/client",{level:e,message:t,component:r.component,action:r.action,url:r.url||window.location.href,metadata:r.metadata})}catch(e){console.warn("Failed to send client log:",e)}}error(e,t){console.error("[CLIENT ERROR] ".concat(e),t),this.sendLog("error",e,t)}warn(e,t){console.warn("[CLIENT WARN] ".concat(e),t),this.sendLog("warn",e,t)}info(e,t){console.info("[CLIENT INFO] ".concat(e),t),this.sendLog("info",e,t)}debug(e,t){console.debug("[CLIENT DEBUG] ".concat(e),t),this.sendLog("debug",e,t)}userAction(e,t,r){this.info("User action: ".concat(e),{component:t,action:e,metadata:r})}apiError(e,t,r){var a;this.error("API Error: ".concat(e),{component:"API",action:"request",metadata:{endpoint:e,error:(null==t?void 0:t.message)||t,status:null==t?void 0:null===(a=t.response)||void 0===a?void 0:a.status,...r}})}navigation(e,t){this.info("Navigation: ".concat(e," -> ").concat(t),{component:"Router",action:"navigation",metadata:{from:e,to:t}})}componentError(e,t,r){this.error("Component Error: ".concat(e),{component:e,action:"render",metadata:{error:(null==t?void 0:t.message)||t,stack:null==t?void 0:t.stack,...r}})}constructor(){this.isEnabled=!0,this.isEnabled=!1}}let s=new i,l=(0,o.createContext)(void 0);function c(e){let{children:t}=e,[r,i]=(0,o.useState)(null),[c,d]=(0,o.useState)(!0);(0,o.useEffect)(()=>{u()},[]);let u=async()=>{let e=localStorage.getItem("token");if(!e){d(!1);return}n.h.defaults.headers.common.Authorization="Bearer ".concat(e);let t=0;for(;t<5;)try{let e=await n.h.get("/auth/profile");i(e.data),d(!1);return}catch(a){var r;let e=null==a?void 0:null===(r=a.response)||void 0===r?void 0:r.status;if(t++,401===e||403===e){localStorage.removeItem("token"),delete n.h.defaults.headers.common.Authorization,i(null),d(!1);return}await new Promise(e=>setTimeout(e,Math.min(5e3,500*t)))}d(!1)},h=async(e,t)=>{try{s.info("Login attempt",{component:"Auth",action:"login",metadata:{email:e}});let{user:r,token:a,requiresTwoFactor:o,userId:l,requiresPasswordChange:c}=(await n.h.post("/auth/login",{email:e,password:t})).data;if(o)return{requiresTwoFactor:!0,userId:l};if(c)return{requiresPasswordChange:!0,userId:l};return localStorage.setItem("token",a),n.h.defaults.headers.common.Authorization="Bearer ".concat(a),i(r),s.info("Login successful",{component:"Auth",action:"login",metadata:{userId:r.id,email:e}}),{}}catch(i){var r,a,o;let t=null==i?void 0:null===(r=i.response)||void 0===r?void 0:r.status,n=null==i?void 0:null===(o=i.response)||void 0===o?void 0:null===(a=o.data)||void 0===a?void 0:a.error;throw s.apiError("/auth/login",i,{email:e}),Error(401===t?"Неверный email или пароль":500===t?"Ошибка сервера при входе":n||"Ошибка входа")}},m=async e=>{try{let{token:t,user:r}=(await n.h.post("/auth/register",e)).data;if(t&&r)return localStorage.setItem("token",t),n.h.defaults.headers.common.Authorization="Bearer ".concat(t),i(r),{token:t};return{}}catch(n){var t,r,a;let e=null==n?void 0:null===(t=n.response)||void 0===t?void 0:t.status,o=null==n?void 0:null===(a=n.response)||void 0===a?void 0:null===(r=a.data)||void 0===r?void 0:r.error;throw Error(409===e?"Пользователь с таким email уже существует":o||"Ошибка регистрации")}},v=async e=>{try{let t=await n.h.put("/auth/profile",e);i(e=>e?{...e,...t.data}:null)}catch(e){var t,r;throw Error((null===(r=e.response)||void 0===r?void 0:null===(t=r.data)||void 0===t?void 0:t.error)||"Ошибка обновления профиля")}},f=async(e,t)=>{try{let{token:r,user:a}=(await n.h.post("/auth/verify-2fa",{userId:e,code:t})).data;return localStorage.setItem("token",r),n.h.defaults.headers.common.Authorization="Bearer ".concat(r),i(a),r}catch(e){var r,a;throw Error((null==e?void 0:null===(a=e.response)||void 0===a?void 0:null===(r=a.data)||void 0===r?void 0:r.error)||"Ошибка подтверждения 2FA")}},p=async(e,t)=>{try{let{token:r,user:a}=(await n.h.post("/auth/verify-email",{userId:e,code:t})).data;return r&&(localStorage.setItem("token",r),n.h.defaults.headers.common.Authorization="Bearer ".concat(r),i(a)),r}catch(e){var r,a;throw Error((null==e?void 0:null===(a=e.response)||void 0===a?void 0:null===(r=a.data)||void 0===r?void 0:r.error)||"Ошибка подтверждения email")}},x=async(e,t)=>{try{await n.h.post("/auth/resend-code",{userId:e,type:t})}catch(e){var r,a;throw Error((null==e?void 0:null===(a=e.response)||void 0===a?void 0:null===(r=a.data)||void 0===r?void 0:r.error)||"Ошибка отправки кода")}},g=async e=>{try{return(await n.h.post("/auth/check-company",{inn:e})).data}catch(e){var t,r;throw Error((null==e?void 0:null===(r=e.response)||void 0===r?void 0:null===(t=r.data)||void 0===t?void 0:t.error)||"Ошибка проверки компании")}},y=async(e,t,r)=>{try{await n.h.put("/auth/force-change-password",{userId:e,currentPassword:t,newPassword:r})}catch(e){var a,o;throw Error((null==e?void 0:null===(o=e.response)||void 0===o?void 0:null===(a=o.data)||void 0===a?void 0:a.error)||"Ошибка смены пароля")}};return(0,a.jsx)(l.Provider,{value:{user:r,loading:c,login:h,register:m,logout:()=>{s.info("User logout",{component:"Auth",action:"logout",metadata:{userId:null==r?void 0:r.id}}),localStorage.removeItem("token"),delete n.h.defaults.headers.common.Authorization,i(null),window.location.href="/login"},updateProfile:v,verifyTwoFactor:f,verifyEmail:p,resendCode:x,checkCompany:g,forceChangePassword:y},children:t})}function d(){let e=(0,o.useContext)(l);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}}}]);